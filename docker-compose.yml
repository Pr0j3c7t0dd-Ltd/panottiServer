services:
  app:
    build: .
    ports:
      - "127.0.0.1:54789:8443"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./.env:/app/.env
      - ./scripts:/app/scripts
      - ./ssl:/app/ssl
      - ./app/plugins:/app/app/plugins
      - whisper_models:/app/models/whisper
      - ./app:/app/app
      - ${RECORDINGS_DIR}:${RECORDINGS_DIR}
      - ./recordings:/app/recordings
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - WHISPER_MODEL_PATH=/app/models/whisper
      - POETRY_VIRTUALENVS_CREATE=false
      - DEBUG=1
      - SSL_CERT_FILE=/app/ssl/cert.pem
      - SSL_KEY_FILE=/app/ssl/key.pem
      - UVICORN_HOST=0.0.0.0
    networks:
      - internal
      - external
    depends_on:
      ollama:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-k", "-f", "https://127.0.0.1:8443/docs"]
      interval: 30s
      timeout: 30s
      retries: 10
      start_period: 120s
    command: >
      sh -c "
      echo 'Waiting for Ollama to be healthy...' &&
      until curl -s http://ollama:11434/api/version > /dev/null; do
        echo 'Waiting for Ollama...' &&
        sleep 5;
      done &&
      echo 'Ollama is ready!' &&
      echo '=== Environment ===' &&
      env | sort &&
      echo '=== Directory Structure ===' &&
      ls -laR /app &&
      echo '=== Starting App ===' &&
      /app/docker-entrypoint.sh
      "

  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - internal
    environment:
      - GIN_MODE=release
      - OLLAMA_ORIGINS=*
      - OLLAMA_HOST=0.0.0.0:11434
      - OLLAMA_COMPUTE=cpu
      - GOAMD64=v3
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:11434/api/version || exit 0"]
      interval: 60s
      timeout: 60s
      retries: 15
      start_period: 180s
    restart: unless-stopped
    entrypoint: ["ollama"]
    command: ["serve"]

networks:
  internal:
    internal: true
  external:
    internal: false

volumes:
  ollama_data:
  whisper_models: 